# AI英语工作助手 - 数据库设计文档

## 数据库架构概览

### 技术选型
- **主数据库**: PostgreSQL 15+
- **缓存数据库**: Redis 7+
- **搜索引擎**: Elasticsearch 8+
- **向量数据库**: Qdrant (用于语义搜索)
- **连接池**: PgBouncer
- **备份策略**: WAL-E + S3

### 架构图
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   应用服务器     │    │   Redis缓存      │    │  Elasticsearch  │
│   (FastAPI)     │◄──►│   (会话/缓存)    │    │   (全文搜索)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                                              │
         ▼                                              │
┌─────────────────┐    ┌─────────────────┐             │
│  PostgreSQL     │    │    Qdrant       │             │
│  (主数据库)      │    │  (向量搜索)      │◄────────────┘
└─────────────────┘    └─────────────────┘
```

## 数据表设计

### 1. 用户管理模块

#### 1.1 用户表 (users)
```sql
CREATE TABLE users (
    user_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    name VARCHAR(100) NOT NULL,
    avatar_url VARCHAR(500),
    subscription_type VARCHAR(20) DEFAULT 'free' CHECK (subscription_type IN ('free', 'premium', 'enterprise')),
    subscription_expires_at TIMESTAMP WITH TIME ZONE,
    language_preference JSONB DEFAULT '{"source": "en", "target": "zh"}',
    timezone VARCHAR(50) DEFAULT 'Asia/Shanghai',
    is_active BOOLEAN DEFAULT true,
    email_verified BOOLEAN DEFAULT false,
    last_login_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_subscription ON users(subscription_type, subscription_expires_at);
CREATE INDEX idx_users_created_at ON users(created_at);

-- 触发器：自动更新 updated_at
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

#### 1.2 用户设置表 (user_settings)
```sql
CREATE TABLE user_settings (
    setting_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    category VARCHAR(50) NOT NULL, -- 'translation', 'review', 'notification', 'privacy'
    settings JSONB NOT NULL DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(user_id, category)
);

-- 索引
CREATE INDEX idx_user_settings_user_id ON user_settings(user_id);
CREATE INDEX idx_user_settings_category ON user_settings(category);

-- 触发器
CREATE TRIGGER update_user_settings_updated_at BEFORE UPDATE ON user_settings
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- 示例数据结构
/*
翻译设置:
{
  "auto_translate": true,
  "hover_delay": 500,
  "show_pronunciation": true,
  "save_to_history": true,
  "default_source_lang": "en",
  "default_target_lang": "zh"
}

复习设置:
{
  "daily_goal": 20,
  "reminder_time": "09:00",
  "weekend_reviews": true,
  "difficulty_adjustment": "auto",
  "review_types": ["recognition", "recall", "spelling"]
}

通知设置:
{
  "email_notifications": true,
  "push_notifications": true,
  "review_reminders": true,
  "weekly_reports": true,
  "achievement_notifications": true
}
*/
```

#### 1.3 用户会话表 (user_sessions)
```sql
CREATE TABLE user_sessions (
    session_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    token_hash VARCHAR(255) NOT NULL,
    refresh_token_hash VARCHAR(255),
    device_info JSONB,
    ip_address INET,
    user_agent TEXT,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    last_used_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_user_sessions_user_id ON user_sessions(user_id);
CREATE INDEX idx_user_sessions_token ON user_sessions(token_hash);
CREATE INDEX idx_user_sessions_expires ON user_sessions(expires_at);
```

### 2. 翻译模块

#### 2.1 翻译历史表 (translation_history)
```sql
CREATE TABLE translation_history (
    translation_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    original_text TEXT NOT NULL,
    translated_text TEXT NOT NULL,
    source_lang VARCHAR(10) NOT NULL,
    target_lang VARCHAR(10) NOT NULL,
    translation_engine VARCHAR(50) DEFAULT 'openai', -- 'openai', 'google', 'baidu'
    confidence_score DECIMAL(3,2), -- 0.00-1.00
    context_info JSONB, -- 上下文信息
    source_url TEXT,
    source_type VARCHAR(20) DEFAULT 'text', -- 'text', 'image', 'audio'
    processing_time_ms INTEGER,
    is_saved_to_vocabulary BOOLEAN DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_translation_history_user_id ON translation_history(user_id);
CREATE INDEX idx_translation_history_created_at ON translation_history(created_at);
CREATE INDEX idx_translation_history_source_lang ON translation_history(source_lang, target_lang);
CREATE INDEX idx_translation_history_text_search ON translation_history USING gin(to_tsvector('english', original_text));

-- 分区表（按月分区）
CREATE TABLE translation_history_y2024m01 PARTITION OF translation_history
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
```

#### 2.2 翻译缓存表 (translation_cache)
```sql
CREATE TABLE translation_cache (
    cache_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    text_hash VARCHAR(64) NOT NULL, -- SHA256 hash of original text
    original_text TEXT NOT NULL,
    translated_text TEXT NOT NULL,
    source_lang VARCHAR(10) NOT NULL,
    target_lang VARCHAR(10) NOT NULL,
    translation_engine VARCHAR(50) NOT NULL,
    confidence_score DECIMAL(3,2),
    hit_count INTEGER DEFAULT 1,
    last_hit_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP WITH TIME ZONE DEFAULT (CURRENT_TIMESTAMP + INTERVAL '30 days'),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(text_hash, source_lang, target_lang, translation_engine)
);

-- 索引
CREATE INDEX idx_translation_cache_hash ON translation_cache(text_hash);
CREATE INDEX idx_translation_cache_expires ON translation_cache(expires_at);
```

### 3. 词汇管理模块

#### 3.1 词汇表 (vocabularies)
```sql
CREATE TABLE vocabularies (
    vocabulary_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    word VARCHAR(200) NOT NULL,
    translation TEXT NOT NULL,
    pronunciation JSONB, -- {"ipa": "/həˈloʊ/", "audio_url": "..."}
    part_of_speech VARCHAR(20), -- 'noun', 'verb', 'adjective', etc.
    definition TEXT,
    context TEXT,
    example_sentences JSONB, -- [{"en": "...", "zh": "..."}, ...]
    source_url TEXT,
    difficulty_level INTEGER CHECK (difficulty_level BETWEEN 1 AND 5),
    frequency_rank INTEGER, -- 词频排名
    tags TEXT[], -- 标签数组
    notes TEXT, -- 用户笔记
    
    -- 学习相关字段
    mastery_level INTEGER DEFAULT 0 CHECK (mastery_level BETWEEN 0 AND 5),
    review_count INTEGER DEFAULT 0,
    correct_count INTEGER DEFAULT 0,
    last_reviewed_at TIMESTAMP WITH TIME ZONE,
    next_review_date TIMESTAMP WITH TIME ZONE,
    interval_days INTEGER DEFAULT 1,
    ease_factor DECIMAL(3,2) DEFAULT 2.50, -- SuperMemo算法参数
    
    -- 元数据
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(user_id, word)
);

-- 索引
CREATE INDEX idx_vocabularies_user_id ON vocabularies(user_id);
CREATE INDEX idx_vocabularies_word ON vocabularies(word);
CREATE INDEX idx_vocabularies_next_review ON vocabularies(next_review_date) WHERE is_active = true;
CREATE INDEX idx_vocabularies_mastery ON vocabularies(mastery_level);
CREATE INDEX idx_vocabularies_difficulty ON vocabularies(difficulty_level);
CREATE INDEX idx_vocabularies_tags ON vocabularies USING gin(tags);
CREATE INDEX idx_vocabularies_search ON vocabularies USING gin(to_tsvector('english', word || ' ' || translation));

-- 触发器
CREATE TRIGGER update_vocabularies_updated_at BEFORE UPDATE ON vocabularies
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

#### 3.2 词汇关系表 (vocabulary_relations)
```sql
CREATE TABLE vocabulary_relations (
    relation_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    source_vocabulary_id UUID NOT NULL REFERENCES vocabularies(vocabulary_id) ON DELETE CASCADE,
    target_vocabulary_id UUID NOT NULL REFERENCES vocabularies(vocabulary_id) ON DELETE CASCADE,
    relation_type VARCHAR(20) NOT NULL, -- 'synonym', 'antonym', 'related', 'derivative'
    strength DECIMAL(3,2) DEFAULT 1.00, -- 关系强度 0.00-1.00
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(source_vocabulary_id, target_vocabulary_id, relation_type)
);

-- 索引
CREATE INDEX idx_vocabulary_relations_source ON vocabulary_relations(source_vocabulary_id);
CREATE INDEX idx_vocabulary_relations_target ON vocabulary_relations(target_vocabulary_id);
CREATE INDEX idx_vocabulary_relations_type ON vocabulary_relations(relation_type);
```

#### 3.3 词汇标签表 (vocabulary_tags)
```sql
CREATE TABLE vocabulary_tags (
    tag_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    tag_name VARCHAR(50) NOT NULL,
    tag_color VARCHAR(7) DEFAULT '#007bff', -- HEX color
    description TEXT,
    vocabulary_count INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(user_id, tag_name)
);

-- 索引
CREATE INDEX idx_vocabulary_tags_user_id ON vocabulary_tags(user_id);
CREATE INDEX idx_vocabulary_tags_name ON vocabulary_tags(tag_name);
```

### 4. Agent系统模块

#### 4.1 Agent会话表 (agent_sessions)
```sql
CREATE TABLE agent_sessions (
    session_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    session_type VARCHAR(50) NOT NULL, -- 'translation', 'batch_translation', 'ocr_translation'
    workflow_name VARCHAR(100) NOT NULL, -- 'EnterpriseAgentSystem', 'BatchProcessor'
    status VARCHAR(20) NOT NULL DEFAULT 'created', -- 'created', 'running', 'completed', 'failed', 'cancelled'
    current_step VARCHAR(100), -- 当前执行的步骤
    progress_percentage INTEGER DEFAULT 0 CHECK (progress_percentage BETWEEN 0 AND 100),
    
    -- 输入输出数据
    input_data JSONB NOT NULL, -- 原始输入数据
    output_data JSONB, -- 最终输出结果
    intermediate_results JSONB, -- 中间结果
    
    -- 性能指标
    processing_time_ms INTEGER,
    quality_score DECIMAL(3,2),
    confidence_score DECIMAL(3,2),
    
    -- 错误处理
    error_log JSONB, -- 错误日志数组
    retry_count INTEGER DEFAULT 0,
    
    -- 时间戳
    started_at TIMESTAMP WITH TIME ZONE,
    completed_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_agent_sessions_user_id ON agent_sessions(user_id);
CREATE INDEX idx_agent_sessions_status ON agent_sessions(status);
CREATE INDEX idx_agent_sessions_type ON agent_sessions(session_type);
CREATE INDEX idx_agent_sessions_created_at ON agent_sessions(created_at);
CREATE INDEX idx_agent_sessions_workflow ON agent_sessions(workflow_name);

-- 触发器
CREATE TRIGGER update_agent_sessions_updated_at BEFORE UPDATE ON agent_sessions
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

#### 4.2 Agent工作流步骤表 (agent_workflow_steps)
```sql
CREATE TABLE agent_workflow_steps (
    step_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id UUID NOT NULL REFERENCES agent_sessions(session_id) ON DELETE CASCADE,
    step_name VARCHAR(100) NOT NULL,
    step_order INTEGER NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'pending', -- 'pending', 'running', 'completed', 'failed', 'skipped'
    
    -- 步骤数据
    input_data JSONB,
    output_data JSONB,
    step_config JSONB, -- 步骤配置参数
    
    -- 性能指标
    execution_time_ms INTEGER,
    memory_usage_mb INTEGER,
    
    -- 错误信息
    error_message TEXT,
    error_details JSONB,
    
    -- 时间戳
    started_at TIMESTAMP WITH TIME ZONE,
    completed_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_workflow_steps_session_id ON agent_workflow_steps(session_id);
CREATE INDEX idx_workflow_steps_order ON agent_workflow_steps(session_id, step_order);
CREATE INDEX idx_workflow_steps_status ON agent_workflow_steps(status);
CREATE INDEX idx_workflow_steps_name ON agent_workflow_steps(step_name);
```

#### 4.3 Agent检查点表 (agent_checkpoints)
```sql
CREATE TABLE agent_checkpoints (
    checkpoint_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id UUID NOT NULL REFERENCES agent_sessions(session_id) ON DELETE CASCADE,
    thread_id VARCHAR(100) NOT NULL, -- LangGraph thread ID
    checkpoint_data JSONB NOT NULL, -- 序列化的状态数据
    checkpoint_metadata JSONB, -- 检查点元数据
    
    -- 版本控制
    version_number INTEGER NOT NULL DEFAULT 1,
    parent_checkpoint_id UUID REFERENCES agent_checkpoints(checkpoint_id),
    
    -- 状态信息
    state_summary JSONB, -- 状态摘要
    next_steps TEXT[], -- 下一步可能的操作
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(session_id, thread_id, version_number)
);

-- 索引
CREATE INDEX idx_checkpoints_session_id ON agent_checkpoints(session_id);
CREATE INDEX idx_checkpoints_thread_id ON agent_checkpoints(thread_id);
CREATE INDEX idx_checkpoints_version ON agent_checkpoints(session_id, version_number);
CREATE INDEX idx_checkpoints_created_at ON agent_checkpoints(created_at);
```

#### 4.4 Agent性能指标表 (agent_metrics)
```sql
CREATE TABLE agent_metrics (
    metric_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id UUID NOT NULL REFERENCES agent_sessions(session_id) ON DELETE CASCADE,
    metric_name VARCHAR(100) NOT NULL,
    metric_value DECIMAL(10,4) NOT NULL,
    metric_unit VARCHAR(20), -- 'ms', 'mb', 'percentage', 'count'
    metric_category VARCHAR(50), -- 'performance', 'quality', 'usage'
    
    -- 聚合信息
    aggregation_type VARCHAR(20), -- 'sum', 'avg', 'max', 'min', 'count'
    time_window VARCHAR(20), -- 'step', 'session', 'daily', 'hourly'
    
    recorded_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_agent_metrics_session_id ON agent_metrics(session_id);
CREATE INDEX idx_agent_metrics_name ON agent_metrics(metric_name);
CREATE INDEX idx_agent_metrics_category ON agent_metrics(metric_category);
CREATE INDEX idx_agent_metrics_recorded_at ON agent_metrics(recorded_at);
```

### 5. 复习系统模块

#### 5.1 复习计划表 (review_schedule)
```sql
CREATE TABLE review_schedule (
    schedule_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    vocabulary_id UUID NOT NULL REFERENCES vocabularies(vocabulary_id) ON DELETE CASCADE,
    scheduled_date DATE NOT NULL,
    review_type VARCHAR(20) NOT NULL, -- 'recognition', 'recall', 'spelling', 'listening'
    priority INTEGER DEFAULT 1, -- 1-5, 5为最高优先级
    estimated_duration_seconds INTEGER DEFAULT 30,
    is_completed BOOLEAN DEFAULT false,
    completed_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(vocabulary_id, scheduled_date, review_type)
);

-- 索引
CREATE INDEX idx_review_schedule_user_date ON review_schedule(user_id, scheduled_date);
CREATE INDEX idx_review_schedule_vocabulary ON review_schedule(vocabulary_id);
CREATE INDEX idx_review_schedule_pending ON review_schedule(user_id, scheduled_date) 
    WHERE is_completed = false;
```

#### 4.2 复习记录表 (review_records)
```sql
CREATE TABLE review_records (
    record_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    vocabulary_id UUID NOT NULL REFERENCES vocabularies(vocabulary_id) ON DELETE CASCADE,
    schedule_id UUID REFERENCES review_schedule(schedule_id) ON DELETE SET NULL,
    review_type VARCHAR(20) NOT NULL,
    quality_score INTEGER NOT NULL CHECK (quality_score BETWEEN 0 AND 5), -- SuperMemo质量评分
    response_time_ms INTEGER,
    user_answer TEXT,
    is_correct BOOLEAN,
    hints_used INTEGER DEFAULT 0,
    
    -- 算法相关
    previous_interval_days INTEGER,
    new_interval_days INTEGER,
    previous_ease_factor DECIMAL(3,2),
    new_ease_factor DECIMAL(3,2),
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_review_records_user_id ON review_records(user_id);
CREATE INDEX idx_review_records_vocabulary ON review_records(vocabulary_id);
CREATE INDEX idx_review_records_created_at ON review_records(created_at);

-- 分区表（按月分区）
CREATE TABLE review_records_y2024m01 PARTITION OF review_records
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
```

#### 4.3 学习统计表 (learning_statistics)
```sql
CREATE TABLE learning_statistics (
    stat_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    stat_date DATE NOT NULL,
    
    -- 学习数据
    new_words_learned INTEGER DEFAULT 0,
    words_reviewed INTEGER DEFAULT 0,
    correct_reviews INTEGER DEFAULT 0,
    total_study_time_seconds INTEGER DEFAULT 0,
    
    -- 翻译数据
    translations_count INTEGER DEFAULT 0,
    unique_words_translated INTEGER DEFAULT 0,
    
    -- 详细统计
    difficulty_breakdown JSONB DEFAULT '{}', -- {"1": {"total": 10, "correct": 8}, ...}
    review_type_breakdown JSONB DEFAULT '{}',
    hourly_activity JSONB DEFAULT '{}', -- {"09": 15, "10": 23, ...}
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(user_id, stat_date)
);

-- 索引
CREATE INDEX idx_learning_statistics_user_date ON learning_statistics(user_id, stat_date);
CREATE INDEX idx_learning_statistics_date ON learning_statistics(stat_date);

-- 触发器
CREATE TRIGGER update_learning_statistics_updated_at BEFORE UPDATE ON learning_statistics
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### 5. 成就系统模块

#### 5.1 成就定义表 (achievements)
```sql
CREATE TABLE achievements (
    achievement_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    achievement_key VARCHAR(50) UNIQUE NOT NULL, -- 'first_word', 'streak_7_days', etc.
    title JSONB NOT NULL, -- {"en": "First Word", "zh": "第一个单词"}
    description JSONB NOT NULL,
    icon_url VARCHAR(500),
    category VARCHAR(30) NOT NULL, -- 'learning', 'streak', 'milestone', 'special'
    difficulty VARCHAR(20) DEFAULT 'normal', -- 'easy', 'normal', 'hard', 'legendary'
    points INTEGER DEFAULT 10,
    
    -- 解锁条件
    unlock_conditions JSONB NOT NULL,
    /*
    示例条件:
    {
      "type": "streak_days",
      "value": 7
    }
    或
    {
      "type": "words_learned",
      "value": 100
    }
    或
    {
      "type": "composite",
      "conditions": [
        {"type": "words_learned", "value": 50},
        {"type": "accuracy_rate", "value": 0.9, "period_days": 7}
      ]
    }
    */
    
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_achievements_category ON achievements(category);
CREATE INDEX idx_achievements_difficulty ON achievements(difficulty);
```

#### 5.2 用户成就表 (user_achievements)
```sql
CREATE TABLE user_achievements (
    user_achievement_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    achievement_id UUID NOT NULL REFERENCES achievements(achievement_id) ON DELETE CASCADE,
    progress DECIMAL(5,2) DEFAULT 0.00, -- 进度百分比 0.00-100.00
    is_unlocked BOOLEAN DEFAULT false,
    unlocked_at TIMESTAMP WITH TIME ZONE,
    notification_sent BOOLEAN DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(user_id, achievement_id)
);

-- 索引
CREATE INDEX idx_user_achievements_user_id ON user_achievements(user_id);
CREATE INDEX idx_user_achievements_unlocked ON user_achievements(user_id, is_unlocked);
CREATE INDEX idx_user_achievements_progress ON user_achievements(user_id, progress) 
    WHERE is_unlocked = false;
```

### 6. 系统配置模块

#### 6.1 系统配置表 (system_config)
```sql
CREATE TABLE system_config (
    config_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    config_key VARCHAR(100) UNIQUE NOT NULL,
    config_value JSONB NOT NULL,
    description TEXT,
    is_public BOOLEAN DEFAULT false, -- 是否对客户端公开
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_system_config_key ON system_config(config_key);
CREATE INDEX idx_system_config_public ON system_config(is_public) WHERE is_public = true;

-- 触发器
CREATE TRIGGER update_system_config_updated_at BEFORE UPDATE ON system_config
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- 初始配置数据
INSERT INTO system_config (config_key, config_value, description, is_public) VALUES
('translation_engines', '{"primary": "openai", "fallback": ["google", "baidu"]}', '翻译引擎配置', false),
('rate_limits', '{"free": {"translations_per_hour": 100}, "premium": {"translations_per_hour": 1000}}', '限流配置', false),
('review_algorithm', '{"algorithm": "sm2", "initial_interval": 1, "max_interval": 365}', '复习算法配置', false),
('supported_languages', '["en", "zh", "ja", "ko", "fr", "de", "es"]', '支持的语言', true);
```

#### 6.2 API使用统计表 (api_usage_stats)
```sql
CREATE TABLE api_usage_stats (
    stat_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(user_id) ON DELETE CASCADE,
    endpoint VARCHAR(100) NOT NULL,
    method VARCHAR(10) NOT NULL,
    status_code INTEGER NOT NULL,
    response_time_ms INTEGER,
    request_size_bytes INTEGER,
    response_size_bytes INTEGER,
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_api_usage_stats_user_id ON api_usage_stats(user_id);
CREATE INDEX idx_api_usage_stats_endpoint ON api_usage_stats(endpoint);
CREATE INDEX idx_api_usage_stats_created_at ON api_usage_stats(created_at);

-- 分区表（按日分区）
CREATE TABLE api_usage_stats_y2024m01d01 PARTITION OF api_usage_stats
    FOR VALUES FROM ('2024-01-01') TO ('2024-01-02');
```

## 视图定义

### 1. 用户学习概览视图
```sql
CREATE VIEW user_learning_overview AS
SELECT 
    u.user_id,
    u.name,
    u.email,
    u.subscription_type,
    COUNT(DISTINCT v.vocabulary_id) as total_vocabularies,
    COUNT(DISTINCT CASE WHEN v.mastery_level >= 3 THEN v.vocabulary_id END) as mastered_words,
    COALESCE(AVG(v.mastery_level), 0) as avg_mastery_level,
    COUNT(DISTINCT CASE WHEN rs.scheduled_date = CURRENT_DATE AND rs.is_completed = false THEN rs.schedule_id END) as pending_reviews_today,
    COALESCE(ls_today.total_study_time_seconds, 0) as study_time_today_seconds,
    COALESCE(ls_week.total_study_time_seconds, 0) as study_time_week_seconds,
    u.created_at as joined_at
FROM users u
LEFT JOIN vocabularies v ON u.user_id = v.user_id AND v.is_active = true
LEFT JOIN review_schedule rs ON u.user_id = rs.user_id
LEFT JOIN learning_statistics ls_today ON u.user_id = ls_today.user_id AND ls_today.stat_date = CURRENT_DATE
LEFT JOIN (
    SELECT 
        user_id, 
        SUM(total_study_time_seconds) as total_study_time_seconds
    FROM learning_statistics 
    WHERE stat_date >= CURRENT_DATE - INTERVAL '7 days'
    GROUP BY user_id
) ls_week ON u.user_id = ls_week.user_id
WHERE u.is_active = true
GROUP BY u.user_id, u.name, u.email, u.subscription_type, u.created_at, 
         ls_today.total_study_time_seconds, ls_week.total_study_time_seconds;
```

### 2. 词汇复习优先级视图
```sql
CREATE VIEW vocabulary_review_priority AS
SELECT 
    v.vocabulary_id,
    v.user_id,
    v.word,
    v.translation,
    v.difficulty_level,
    v.mastery_level,
    v.next_review_date,
    v.interval_days,
    v.ease_factor,
    -- 计算优先级分数
    (
        -- 基础分数：越难的词分数越高
        v.difficulty_level * 10 +
        -- 掌握程度：越不熟练分数越高
        (5 - v.mastery_level) * 15 +
        -- 过期天数：过期越久分数越高
        GREATEST(0, EXTRACT(DAY FROM CURRENT_DATE - v.next_review_date)) * 5 +
        -- 错误率：错误率越高分数越高
        CASE 
            WHEN v.review_count > 0 THEN 
                (1.0 - CAST(v.correct_count AS DECIMAL) / v.review_count) * 20
            ELSE 10
        END
    ) as priority_score,
    CASE 
        WHEN v.next_review_date <= CURRENT_DATE THEN 'due'
        WHEN v.next_review_date <= CURRENT_DATE + INTERVAL '1 day' THEN 'upcoming'
        ELSE 'future'
    END as review_status
FROM vocabularies v
WHERE v.is_active = true
ORDER BY priority_score DESC;
```

## 存储过程

### 1. 更新词汇复习间隔
```sql
CREATE OR REPLACE FUNCTION update_vocabulary_review_interval(
    p_vocabulary_id UUID,
    p_quality_score INTEGER
) RETURNS VOID AS $$
DECLARE
    v_current_interval INTEGER;
    v_current_ease_factor DECIMAL(3,2);
    v_new_interval INTEGER;
    v_new_ease_factor DECIMAL(3,2);
BEGIN
    -- 获取当前参数
    SELECT interval_days, ease_factor 
    INTO v_current_interval, v_current_ease_factor
    FROM vocabularies 
    WHERE vocabulary_id = p_vocabulary_id;
    
    -- SuperMemo SM-2 算法
    IF p_quality_score >= 3 THEN
        -- 回答正确
        IF v_current_interval = 1 THEN
            v_new_interval := 6;
        ELSE
            v_new_interval := ROUND(v_current_interval * v_current_ease_factor);
        END IF;
        
        v_new_ease_factor := v_current_ease_factor + (0.1 - (5 - p_quality_score) * (0.08 + (5 - p_quality_score) * 0.02));
        v_new_ease_factor := GREATEST(1.3, v_new_ease_factor);
    ELSE
        -- 回答错误，重置间隔
        v_new_interval := 1;
        v_new_ease_factor := v_current_ease_factor;
    END IF;
    
    -- 更新词汇表
    UPDATE vocabularies SET
        interval_days = v_new_interval,
        ease_factor = v_new_ease_factor,
        next_review_date = CURRENT_DATE + INTERVAL '1 day' * v_new_interval,
        last_reviewed_at = CURRENT_TIMESTAMP,
        review_count = review_count + 1,
        correct_count = correct_count + CASE WHEN p_quality_score >= 3 THEN 1 ELSE 0 END,
        mastery_level = CASE 
            WHEN p_quality_score >= 4 AND review_count >= 3 THEN LEAST(5, mastery_level + 1)
            WHEN p_quality_score < 3 THEN GREATEST(0, mastery_level - 1)
            ELSE mastery_level
        END,
        updated_at = CURRENT_TIMESTAMP
    WHERE vocabulary_id = p_vocabulary_id;
    
END;
$$ LANGUAGE plpgsql;
```

### 2. 生成每日复习计划
```sql
CREATE OR REPLACE FUNCTION generate_daily_review_schedule(
    p_user_id UUID,
    p_target_date DATE DEFAULT CURRENT_DATE
) RETURNS INTEGER AS $$
DECLARE
    v_daily_goal INTEGER;
    v_generated_count INTEGER := 0;
    v_vocab_record RECORD;
BEGIN
    -- 获取用户每日复习目标
    SELECT COALESCE((settings->>'daily_goal')::INTEGER, 20)
    INTO v_daily_goal
    FROM user_settings 
    WHERE user_id = p_user_id AND category = 'review';
    
    -- 删除已存在的计划
    DELETE FROM review_schedule 
    WHERE user_id = p_user_id AND scheduled_date = p_target_date;
    
    -- 生成复习计划
    FOR v_vocab_record IN (
        SELECT vocabulary_id, difficulty_level, mastery_level
        FROM vocabulary_review_priority
        WHERE user_id = p_user_id 
          AND review_status IN ('due', 'upcoming')
        ORDER BY priority_score DESC
        LIMIT v_daily_goal
    ) LOOP
        -- 根据掌握程度确定复习类型
        INSERT INTO review_schedule (
            user_id, 
            vocabulary_id, 
            scheduled_date, 
            review_type, 
            priority,
            estimated_duration_seconds
        ) VALUES (
            p_user_id,
            v_vocab_record.vocabulary_id,
            p_target_date,
            CASE 
                WHEN v_vocab_record.mastery_level <= 1 THEN 'recognition'
                WHEN v_vocab_record.mastery_level <= 3 THEN 'recall'
                ELSE 'spelling'
            END,
            6 - v_vocab_record.mastery_level, -- 掌握程度越低优先级越高
            30 + v_vocab_record.difficulty_level * 10 -- 根据难度调整预估时间
        );
        
        v_generated_count := v_generated_count + 1;
    END LOOP;
    
    RETURN v_generated_count;
END;
$$ LANGUAGE plpgsql;
```

### 3. 更新学习统计
```sql
CREATE OR REPLACE FUNCTION update_learning_statistics(
    p_user_id UUID,
    p_stat_date DATE DEFAULT CURRENT_DATE,
    p_stat_type VARCHAR DEFAULT 'review', -- 'review', 'translation', 'vocabulary'
    p_data JSONB DEFAULT '{}'
) RETURNS VOID AS $$
BEGIN
    INSERT INTO learning_statistics (
        user_id, 
        stat_date,
        words_reviewed,
        correct_reviews,
        total_study_time_seconds,
        translations_count
    ) VALUES (
        p_user_id,
        p_stat_date,
        CASE WHEN p_stat_type = 'review' THEN 1 ELSE 0 END,
        CASE WHEN p_stat_type = 'review' AND (p_data->>'is_correct')::BOOLEAN THEN 1 ELSE 0 END,
        COALESCE((p_data->>'study_time_seconds')::INTEGER, 0),
        CASE WHEN p_stat_type = 'translation' THEN 1 ELSE 0 END
    )
    ON CONFLICT (user_id, stat_date) DO UPDATE SET
        words_reviewed = learning_statistics.words_reviewed + 
            CASE WHEN p_stat_type = 'review' THEN 1 ELSE 0 END,
        correct_reviews = learning_statistics.correct_reviews + 
            CASE WHEN p_stat_type = 'review' AND (p_data->>'is_correct')::BOOLEAN THEN 1 ELSE 0 END,
        total_study_time_seconds = learning_statistics.total_study_time_seconds + 
            COALESCE((p_data->>'study_time_seconds')::INTEGER, 0),
        translations_count = learning_statistics.translations_count + 
            CASE WHEN p_stat_type = 'translation' THEN 1 ELSE 0 END,
        updated_at = CURRENT_TIMESTAMP;
END;
$$ LANGUAGE plpgsql;
```

## 数据库优化

### 1. 分区策略
```sql
-- 翻译历史按月分区
CREATE TABLE translation_history_y2024m02 PARTITION OF translation_history
    FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');

-- 复习记录按月分区
CREATE TABLE review_records_y2024m02 PARTITION OF review_records
    FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');

-- API统计按日分区
CREATE TABLE api_usage_stats_y2024m01d02 PARTITION OF api_usage_stats
    FOR VALUES FROM ('2024-01-02') TO ('2024-01-03');
```

### 2. 性能优化索引
```sql
-- 复合索引优化查询
CREATE INDEX idx_vocabularies_user_review ON vocabularies(user_id, next_review_date, is_active)
    WHERE next_review_date <= CURRENT_DATE + INTERVAL '7 days';

-- 部分索引优化
CREATE INDEX idx_review_schedule_today ON review_schedule(user_id, priority DESC)
    WHERE scheduled_date = CURRENT_DATE AND is_completed = false;

-- 表达式索引
CREATE INDEX idx_vocabularies_overdue ON vocabularies(
    user_id, 
    EXTRACT(DAY FROM CURRENT_DATE - next_review_date)
) WHERE next_review_date < CURRENT_DATE AND is_active = true;
```

### 3. 数据清理任务
```sql
-- 清理过期的翻译缓存
CREATE OR REPLACE FUNCTION cleanup_expired_cache() RETURNS INTEGER AS $$
DECLARE
    deleted_count INTEGER;
BEGIN
    DELETE FROM translation_cache WHERE expires_at < CURRENT_TIMESTAMP;
    GET DIAGNOSTICS deleted_count = ROW_COUNT;
    RETURN deleted_count;
END;
$$ LANGUAGE plpgsql;

-- 清理过期的用户会话
CREATE OR REPLACE FUNCTION cleanup_expired_sessions() RETURNS INTEGER AS $$
DECLARE
    deleted_count INTEGER;
BEGIN
    DELETE FROM user_sessions 
    WHERE expires_at < CURRENT_TIMESTAMP OR last_used_at < CURRENT_TIMESTAMP - INTERVAL '30 days';
    GET DIAGNOSTICS deleted_count = ROW_COUNT;
    RETURN deleted_count;
END;
$$ LANGUAGE plpgsql;

-- 归档旧的API统计数据
CREATE OR REPLACE FUNCTION archive_old_api_stats() RETURNS INTEGER AS $$
DECLARE
    archived_count INTEGER;
BEGIN
    -- 将30天前的数据移动到归档表
    WITH moved_data AS (
        DELETE FROM api_usage_stats 
        WHERE created_at < CURRENT_TIMESTAMP - INTERVAL '30 days'
        RETURNING *
    )
    INSERT INTO api_usage_stats_archive SELECT * FROM moved_data;
    
    GET DIAGNOSTICS archived_count = ROW_COUNT;
    RETURN archived_count;
END;
$$ LANGUAGE plpgsql;
```

## 备份和恢复策略

### 1. 备份配置
```bash
# 每日全量备份
#!/bin/bash
DATE=$(date +%Y%m%d)
BACKUP_DIR="/backup/postgresql"
DB_NAME="ai_english_assistant"

# 创建备份
pg_dump -h localhost -U postgres -d $DB_NAME -F c -b -v -f "$BACKUP_DIR/full_backup_$DATE.backup"

# 压缩备份文件
gzip "$BACKUP_DIR/full_backup_$DATE.backup"

# 上传到S3
aws s3 cp "$BACKUP_DIR/full_backup_$DATE.backup.gz" "s3://ai-english-backups/postgresql/"

# 清理本地7天前的备份
find $BACKUP_DIR -name "full_backup_*.backup.gz" -mtime +7 -delete
```

### 2. WAL归档配置
```bash
# postgresql.conf
wal_level = replica
archive_mode = on
archive_command = 'aws s3 cp %p s3://ai-english-backups/wal/%f'
max_wal_senders = 3
wal_keep_segments = 32
```

### 3. 恢复脚本
```bash
#!/bin/bash
# 从备份恢复数据库
BACKUP_FILE=$1
DB_NAME="ai_english_assistant"

# 停止应用服务
sudo systemctl stop ai-english-api

# 删除现有数据库
psql -U postgres -c "DROP DATABASE IF EXISTS $DB_NAME;"
psql -U postgres -c "CREATE DATABASE $DB_NAME;"

# 恢复数据
pg_restore -h localhost -U postgres -d $DB_NAME -v $BACKUP_FILE

# 启动应用服务
sudo systemctl start ai-english-api
```

---

**文档版本**: v1.0
**最后更新**: 2024年
**维护团队**: 数据库管理组